
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>useroperations.views &#8212; Geoportal 01.05.2019 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for useroperations.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="k">import</span> <span class="n">error</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpRequest</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>

<span class="kn">from</span> <span class="nn">Geoportal</span> <span class="k">import</span> <span class="n">helper</span>
<span class="kn">from</span> <span class="nn">Geoportal.geoportalObjects</span> <span class="k">import</span> <span class="n">GeoportalJsonResponse</span><span class="p">,</span> <span class="n">GeoportalContext</span>
<span class="kn">from</span> <span class="nn">Geoportal.settings</span> <span class="k">import</span> <span class="n">VIRTUAL_MACHINE</span><span class="p">,</span> <span class="n">LOCAL_MACHINE</span><span class="p">,</span> <span class="n">ROOT_EMAIL_ADDRESS</span><span class="p">,</span> <span class="n">DEFAULT_GUI</span>
<span class="kn">from</span> <span class="nn">useroperations.utils</span> <span class="k">import</span> <span class="n">helper_functions</span>

<span class="kn">from</span> <span class="nn">.forms</span> <span class="k">import</span> <span class="n">RegistrationForm</span><span class="p">,</span> <span class="n">LoginForm</span><span class="p">,</span> <span class="n">PasswordResetForm</span><span class="p">,</span> <span class="n">ChangeProfileForm</span><span class="p">,</span> <span class="n">DeleteProfileForm</span><span class="p">,</span> <span class="n">FeedbackForm</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">MbUser</span><span class="p">,</span> <span class="n">MbGroup</span><span class="p">,</span> <span class="n">MbUserMbGroup</span><span class="p">,</span> <span class="n">MbRole</span><span class="p">,</span> <span class="n">GuiMbUser</span><span class="p">,</span> <span class="n">MbProxyLog</span><span class="p">,</span> <span class="n">Wfs</span><span class="p">,</span> <span class="n">Wms</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="k">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="k">import</span> <span class="n">send_mail</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="index_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.index_view">[docs]</a><span class="k">def</span> <span class="nf">index_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">wiki_keyword</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Prepares the index view, and renders the page.</span>

<span class="sd">    This view is the main view and landing page of the project. </span>
<span class="sd">    It includes checking if a mediawiki page should be rendered or not.</span>
<span class="sd">    The default page, if no keyword was given, is favourite_wmcs.html,</span>
<span class="sd">     which shows an overview of the most popular wmc services.</span>


<span class="sd">    Args:</span>
<span class="sd">        request: HTTP request coming from djangos URLconf.</span>
<span class="sd">        wiki_keyword: If a string is present it will be used to render</span>
<span class="sd">         a mediawiki page transparently to the user.</span>
<span class="sd">        HTTPGet(&#39;status&#39;): Checks if the login was successful or not.</span>
<span class="sd">         &#39;status&#39; comes from a mapbender php script(authentication.php)</span>

<span class="sd">    Returns:</span>
<span class="sd">        view: returns the rendered view, which can be:</span>
<span class="sd">         (default): favourite_wmcs.html</span>
<span class="sd">         (wiki): a mediawiki page</span>
<span class="sd">         (viewer): geoportal.html</span>
<span class="sd">         (error): 404.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">LANGUAGE_CODE</span>
    <span class="n">get_params</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="ow">and</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fail&quot;</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Login failed&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:login&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Successfully logged in&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">wiki_keyword</span> <span class="o">==</span> <span class="s2">&quot;viewer&quot;</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;geoportal.html&quot;</span>
    <span class="k">elif</span> <span class="n">wiki_keyword</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;wiki.html&quot;</span>
        <span class="c1"># display the wiki article in the template</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">get_wiki_body_content</span><span class="p">(</span><span class="n">wiki_keyword</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;404.html&quot;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;favourite_wmcs.html&quot;</span>
        <span class="c1"># display the favourite WMCs in the template</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">get_landing_page</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>


    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
               <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
               <span class="s2">&quot;wmc_results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
               <span class="p">}</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

    <span class="c1"># check if this is an ajax call from info search</span>
    <span class="k">if</span> <span class="n">get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info_search&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">get_wiki_body_content</span><span class="p">(</span><span class="n">wiki_keyword</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">GeoportalJsonResponse</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">get_response</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="login_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.login_view">[docs]</a><span class="k">def</span> <span class="nf">login_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; View that handles the login</span>

<span class="sd">    Login is handled by a mapbender php script(authentication.php),</span>
<span class="sd">    this view just takes credentials and forwards it to the script.</span>
<span class="sd">    The script returns a status message to the index view.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: HTTPRequest</span>

<span class="sd">    Returns:</span>
<span class="sd">        The login page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;login&quot;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="n">btn_label_pw</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Forgot Password?&quot;</span><span class="p">)</span>
    <span class="n">btn_label_login</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Login&quot;</span><span class="p">)</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s2">&quot;btn_label_pw&quot;</span><span class="p">:</span> <span class="n">btn_label_pw</span><span class="p">,</span>
        <span class="s2">&quot;btn_label_login&quot;</span><span class="p">:</span> <span class="n">btn_label_login</span><span class="p">,</span>
        <span class="s1">&#39;headline&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Login&quot;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;crispy_form_auth.html&quot;</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="register_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.register_view">[docs]</a><span class="k">def</span> <span class="nf">register_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; View for user registration.</span>

<span class="sd">    On HTTPGet it renders the registration Form in forms.py.</span>
<span class="sd">    On HTTPPost it checks if the username is taken and validates password specification.</span>
<span class="sd">    It uses pythons hashlib.pbkdf2_hmac for password storage.</span>
<span class="sd">    Further it tries to read the mapbender.conf to get the id of the admin user.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: HTTPRequest</span>

<span class="sd">    Returns:</span>
<span class="sd">        RegistrationForm</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;register&quot;</span>
    <span class="n">btn_label</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Registration&quot;</span><span class="p">)</span>
    <span class="n">small_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;id_newsletter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id_survey&quot;</span>
    <span class="p">]</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RegistrationForm</span><span class="p">()</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;headline&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Registration&quot;</span><span class="p">),</span>
        <span class="s2">&quot;btn_label1&quot;</span><span class="p">:</span> <span class="n">btn_label</span><span class="p">,</span>
        <span class="s2">&quot;small_labels&quot;</span><span class="p">:</span> <span class="n">small_labels</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">RegistrationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mb_user_name</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The Username&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">{str_name}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_name</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;is already taken&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:register&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Za-z0-9@#$%&amp;+=!]{9,}&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Password does not meet specified criteria, you need at least one uppercase letter, one lowercase letter, one number, you should have at least 9 characters, allowed special chars are: @#$%&amp;+=!&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:register&#39;</span><span class="p">)</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">MbUser</span><span class="p">()</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_department</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;department&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_description</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_phone</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_organisation_name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;organization&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_newsletter</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;newsletter&#39;</span><span class="p">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_allow_survey</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;survey&#39;</span><span class="p">]</span>

            <span class="c1"># check if passwords match</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;passwordconfirm&#39;</span><span class="p">]:</span>
                <span class="n">salt</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">helper_functions</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
                <span class="n">user</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">bytepw</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">bytepw</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)),</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Passwords do not match&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:register&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">portaladmin</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">get_mapbender_config_value</span><span class="p">(</span><span class="s1">&#39;PORTAL_ADMIN_USER_ID&#39;</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_owner</span> <span class="o">=</span> <span class="n">portaladmin</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_owner</span> <span class="o">=</span> <span class="mi">1</span>


            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_login_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">user</span><span class="o">.</span><span class="n">mb_user_resolution</span> <span class="o">=</span> <span class="mi">72</span>
            <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">user</span><span class="o">.</span><span class="n">activation_key</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">random_string</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
            <span class="c1">#activation_key = user.activation_key</span>

            <span class="n">send_mail</span><span class="p">(</span>
                 <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Activation Mail&quot;</span><span class="p">),</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Hello &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_name</span> <span class="o">+</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;,</span><span class="se">\n\n</span><span class="s2">This is your activation link. It will be valid until the end of the day, &quot;</span>
                  <span class="s2">&quot;please click it!</span><span class="se">\n</span><span class="s2"> Link: http://&quot;</span> <span class="o">+</span> <span class="n">VIRTUAL_MACHINE</span> <span class="o">+</span> <span class="s2">&quot;/activate/&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_key</span><span class="p">),</span>
                <span class="s1">&#39;kontakt@geoportal.de&#39;</span><span class="p">,</span>
                <span class="p">[</span><span class="s1">&#39;root@debian&#39;</span><span class="p">],</span>  <span class="c1"># später email variable eintragen</span>
                <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mb_user_name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">mb_user_name</span><span class="p">)</span>
            <span class="n">UserGroupRel</span> <span class="o">=</span> <span class="n">MbUserMbGroup</span><span class="p">()</span>
            <span class="n">UserGroupRel</span><span class="o">.</span><span class="n">fkey_mb_user</span> <span class="o">=</span> <span class="n">user</span>

            <span class="n">group</span> <span class="o">=</span> <span class="n">MbGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mb_group_name</span><span class="o">=</span><span class="s1">&#39;guest&#39;</span><span class="p">)</span>
            <span class="n">UserGroupRel</span><span class="o">.</span><span class="n">fkey_mb_group</span> <span class="o">=</span> <span class="n">group</span>

            <span class="n">role</span> <span class="o">=</span> <span class="n">MbRole</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">UserGroupRel</span><span class="o">.</span><span class="n">mb_user_mb_group_type</span> <span class="o">=</span> <span class="n">role</span>
            <span class="n">UserGroupRel</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Account creation was successful. &quot;</span>
                                        <span class="s2">&quot;You have to activate your account via email before you can login!&quot;</span> <span class="o">+</span> <span class="n">VIRTUAL_MACHINE</span> <span class="o">+</span> <span class="s2">&quot;/activate/&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_key</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:login&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;crispy_form_no_action.html&#39;</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="pw_reset_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.pw_reset_view">[docs]</a><span class="k">def</span> <span class="nf">pw_reset_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; View to reset password</span>

<span class="sd">    This view has the purpose to regain access if a password is lost.</span>
<span class="sd">    To achieve this the user has to enter the correct username and password combination.</span>
<span class="sd">    After doing so he gets an email with a new password.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: HTTPRequest</span>
<span class="sd">    Returns:</span>
<span class="sd">        PasswordResetForm</span>
<span class="sd">        Email confirmation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pw_reset&quot;</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">PasswordResetForm</span><span class="p">()</span>
    <span class="n">btn_label</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Submit&quot;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s2">&quot;btn_label2&quot;</span><span class="p">:</span> <span class="n">btn_label</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PasswordResetForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>

            <span class="n">username</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>


            <span class="k">if</span> <span class="ow">not</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mb_user_name</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">mb_user_email</span><span class="o">=</span><span class="n">email</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No Account with this Username or Email found&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mb_user_name</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">mb_user_email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
                <span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_email</span>

                <span class="n">newpassword</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">random_string</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

                <span class="n">salt</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">helper_functions</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
                <span class="n">user</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">bytepw</span> <span class="o">=</span> <span class="n">newpassword</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_password</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">newpassword</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">bytepw</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

                <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">send_mail</span><span class="p">(</span>
                    <span class="n">subject</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Lost Password&quot;</span><span class="p">),</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;This is your new password, please change it immediately!</span><span class="se">\n</span><span class="s2"> Password: &quot;</span> <span class="o">+</span> <span class="n">newpassword</span> <span class="p">),</span>
                    <span class="n">from_email</span><span class="o">=</span><span class="s1">&#39;kontakt@geoportal.de&#39;</span><span class="p">,</span>
                    <span class="n">recipient_list</span><span class="o">=</span><span class="p">[</span><span class="n">ROOT_EMAIL_ADDRESS</span><span class="p">],</span>
                    <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Password reset was successful, check your mails. Password: &quot;</span> <span class="o">+</span> <span class="n">newpassword</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:login&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;crispy_form_no_action.html&quot;</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="change_profile_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.change_profile_view">[docs]</a><span class="k">def</span> <span class="nf">change_profile_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; View to change or delete profile data</span>

<span class="sd">    This view is needed if a user wants to change his personal data.</span>
<span class="sd">    To achieve this he has to enter his valid password.</span>
<span class="sd">    Further the user has the option to delete his account.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: HTTPRequest</span>
<span class="sd">    Returns:</span>
<span class="sd">        On HTTPGet it renders the ChangeProfileForm in forms.py.</span>
<span class="sd">        On HTTPPost it checks whether the user wants to delete or change his profile.</span>
<span class="sd">         Afterwards password is checked for both options and action is takes on.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;change_profile&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">session_data</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">get_mapbender_session_by_memcache</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">session_data</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;mb_user_id&#39;</span> <span class="ow">in</span> <span class="n">session_data</span><span class="p">:</span>
                <span class="n">userid</span> <span class="o">=</span> <span class="n">session_data</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;mb_user_id&#39;</span><span class="p">]</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mb_user_id</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">userdata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_name</span><span class="p">,</span>
                    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_email</span><span class="p">,</span>
                    <span class="s1">&#39;department&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_department</span><span class="p">,</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_description</span><span class="p">,</span>
                    <span class="s1">&#39;phone&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_phone</span><span class="p">,</span>
                    <span class="s1">&#39;organization&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_organisation_name</span><span class="p">,</span>
                    <span class="s1">&#39;newsletter&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_newsletter</span><span class="p">,</span>
                    <span class="s1">&#39;survey&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_allow_survey</span><span class="p">,</span>
                    <span class="p">}</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ChangeProfileForm</span><span class="p">(</span><span class="n">userdata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ChangeProfileForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Delete Profile&#39;</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Profil entfernen&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;oldpassword&#39;</span><span class="p">]:</span>
                    <span class="n">salt</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span>
                        <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;oldpassword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">salt</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)),</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Your old Password was wrong&quot;</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:change_profile&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:delete_profile&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Change Profile&#39;</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;submit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Profil bearbeiten&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;oldpassword&#39;</span><span class="p">]:</span>
                    <span class="n">salt</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;oldpassword&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">salt</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Your old Password was wrong&quot;</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:change_profile&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;passwordconfirm&#39;</span><span class="p">]:</span>
                        <span class="n">salt</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">helper_functions</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
                        <span class="n">user</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">bytepw</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                        <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">,</span> <span class="n">bytepw</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Passwords do not match&quot;</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:change_profile&#39;</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_department</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;department&#39;</span><span class="p">]</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_description</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_phone</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_organisation_name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;organization&#39;</span><span class="p">]</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_newsletter</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;newsletter&#39;</span><span class="p">]</span>
                <span class="n">user</span><span class="o">.</span><span class="n">mb_user_allow_survey</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;survey&#39;</span><span class="p">]</span>

                <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Successfully changed data&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:index&#39;</span><span class="p">)</span>

    <span class="n">small_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;id_newsletter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id_survey&quot;</span>
    <span class="p">]</span>
    <span class="n">btn_label_change</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Change Profile&quot;</span><span class="p">)</span>
    <span class="n">btn_label_delete</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Delete Profile&quot;</span><span class="p">)</span>

    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;btn_label1&#39;</span><span class="p">:</span> <span class="n">btn_label_change</span><span class="p">,</span>
        <span class="s1">&#39;btn_label2&#39;</span><span class="p">:</span> <span class="n">btn_label_delete</span><span class="p">,</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;headline&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Change data&quot;</span><span class="p">),</span>
        <span class="s1">&#39;small_labels&#39;</span><span class="p">:</span> <span class="n">small_labels</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;crispy_form_no_action.html&#39;</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="delete_profile_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.delete_profile_view">[docs]</a><span class="k">def</span> <span class="nf">delete_profile_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; View for profile deletion</span>

<span class="sd">    This view handles the deletion of profiles.</span>
<span class="sd">    Users get redirected to this view if they click on &quot;delete profile&quot;</span>
<span class="sd">     in the change profile form and provided a valid password.</span>

<span class="sd">    Args</span>
<span class="sd">        request: HTTPRequest</span>
<span class="sd">    Returns:</span>
<span class="sd">        DeleteProfileForm</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">session_data</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">get_mb_user_session_data</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;delete_profile&quot;</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">DeleteProfileForm</span><span class="p">()</span>
    <span class="n">btn_label</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Delete Profile!&quot;</span><span class="p">)</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
        <span class="s1">&#39;headline&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Delete Profile?&quot;</span><span class="p">),</span>
        <span class="s2">&quot;btn_label2&quot;</span><span class="p">:</span> <span class="n">btn_label</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span>
            <span class="n">session_data</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">get_mapbender_session_by_memcache</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">userid</span> <span class="o">=</span> <span class="n">session_data</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;mb_user_id&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You are not logged in&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:index&#39;</span><span class="p">)</span>

            <span class="n">userid</span> <span class="o">=</span> <span class="n">session_data</span><span class="p">[</span><span class="sa">b</span><span class="s1">&#39;mb_user_id&#39;</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">Wms</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">wms_owner</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">Wfs</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">wfs_owner</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You are owner of registrated services - please delete them or give the ownership to another user.&quot;</span><span class="p">))</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">GuiMbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fkey_mb_user_id</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">GuiMbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mb_user_type</span><span class="o">=</span><span class="s1">&#39;owner&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You are owner of guis/applications - please delete them or give the ownership to another user.&quot;</span><span class="p">))</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">MbProxyLog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">fkey_mb_user_id</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;There are logged service accesses for this user profile. Please connect the service administrators for the billing first.&quot;</span><span class="p">))</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mb_user_id</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">user</span><span class="o">.</span><span class="n">activation_key</span> <span class="o">=</span> <span class="n">helper_functions</span><span class="o">.</span><span class="n">random_string</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
                <span class="n">user</span><span class="o">.</span><span class="n">timestamp_delete</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="n">send_mail</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Reactivation Mail&quot;</span><span class="p">),</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Hello &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">mb_user_name</span> <span class="o">+</span>
                    <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;,</span><span class="se">\n\n</span><span class="s2"> In case the deletion of your account was a mistake, you can reactivate it by clicking this link! &quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Link: http://&quot;</span> <span class="o">+</span> <span class="n">VIRTUAL_MACHINE</span> <span class="o">+</span> <span class="s2">&quot;/activate/&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_key</span><span class="p">),</span>
                    <span class="s1">&#39;kontakt@geoportal.de&#39;</span><span class="p">,</span>
                    <span class="p">[</span><span class="s1">&#39;root@debian&#39;</span><span class="p">],</span>  <span class="c1"># später email variable eintragen</span>
                    <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># user.delete()</span>
                <span class="n">helper_functions</span><span class="o">.</span><span class="n">delete_mapbender_session_by_memcache</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Successfully deleted the user:&quot;</span><span class="p">)</span>
                                 <span class="o">+</span> <span class="s2">&quot; </span><span class="si">{str_name}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">mb_user_name</span><span class="p">)</span>
                                 <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;. In case this was an accident, we sent you a link where you can reactivate &quot;</span>
                                     <span class="s2">&quot;your account for 24 hours!&quot;</span> <span class="o">+</span> <span class="s2">&quot;Link: http://&quot;</span> <span class="o">+</span> <span class="n">VIRTUAL_MACHINE</span> <span class="o">+</span> <span class="s2">&quot;/activate/&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">activation_key</span><span class="p">))</span>

                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:index&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;crispy_form_no_action.html&quot;</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="logout_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.logout_view">[docs]</a><span class="k">def</span> <span class="nf">logout_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; View for logging out users</span>

<span class="sd">    This view deletes the session if a user logs out.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: HTTPRequest</span>

<span class="sd">    Returns:</span>
<span class="sd">        LogoutForm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;current_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;logout&quot;</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">)</span>
        <span class="n">helper_functions</span><span class="o">.</span><span class="n">delete_mapbender_session_by_memcache</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Successfully logged out&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;useroperations:index&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You are not logged in&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;crispy_form_no_action.html&quot;</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="map_viewer_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.map_viewer_view">[docs]</a><span class="k">def</span> <span class="nf">map_viewer_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parse all important data for the map rendering from the session</span>

<span class="sd">    This view is used to hand over all the data that is needed</span>
<span class="sd">     by the mapviewer, which currently is mapbender2.</span>
<span class="sd">    The parameters come from the search interface are therefore</span>
<span class="sd">     included in the URL.</span>



<span class="sd">    Args:</span>
<span class="sd">        request: HTTPReqeust , this in includes all mapviewer</span>
<span class="sd">                  parameters coming from the search module</span>
<span class="sd">    Returns:</span>
<span class="sd">            response: a json object containing all the</span>
<span class="sd">             mapviewer parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lang</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">LANGUAGE_CODE</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

    <span class="n">is_external_search</span> <span class="o">=</span> <span class="s2">&quot;external&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_REFERER&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">request_get_params_dict</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

    <span class="c1"># is regular call means the request comes directly from the navigation menu in the page, without selecting a search result</span>
    <span class="n">is_regular_call</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_get_params_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">request_get_params_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;searchResultParam&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">request_get_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">request_get_params_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;searchResultParam&quot;</span><span class="p">)))</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;geoportal_external.html&quot;</span>
    <span class="n">gui_id</span> <span class="o">=</span> <span class="n">request_get_params_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">DEFAULT_GUI</span><span class="p">)</span> <span class="c1"># get selected gui from params, use default gui otherwise!</span>

    <span class="c1"># if the call targets a DE catalogue result, we need to adjust a little thing here to restore the previously splitted url</span>
    <span class="k">if</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WMS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># yes, this happens when we have a DE catalogue call! Now merge the stuff back into &quot;WMS&quot; again!</span>
        <span class="k">for</span> <span class="n">request_get_params_key</span><span class="p">,</span> <span class="n">request_get_params_val</span> <span class="ow">in</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">request_get_params_key</span> <span class="o">==</span> <span class="s2">&quot;WMS&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">request_get_params</span><span class="p">[</span><span class="s2">&quot;WMS&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">request_get_params_key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">request_get_params_val</span>

    <span class="c1"># ToDo: Implement mb_user_myGui parsing</span>

    <span class="n">mapviewer_params_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;LAYER[id]&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LAYER[id]&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;LAYER[zoom]&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LAYER[zoom]&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;LAYER[visible]&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LAYER[visible]&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;LAYER[querylayer]&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LAYER[querylayer]&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;WMS&quot;</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WMS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;WMC&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WMC&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;GEORSS&quot;</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GEORSS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;KML&quot;</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KML&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;FEATURETYPE&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FEATURETYPE&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;ZOOM&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ZOOM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;GEOJSON&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GEOJSON&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;GEOJSONZOOM&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GEOJSONZOOM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;GEOJSONZOOMOFFSET&quot;</span><span class="p">:</span> <span class="n">request_get_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GEOJSONZOOMOFFSET&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">mapviewer_params</span> <span class="o">=</span> <span class="n">gui_id</span>
    <span class="k">for</span> <span class="n">param_key</span><span class="p">,</span> <span class="n">param_val</span> <span class="ow">in</span> <span class="n">mapviewer_params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">mapviewer_params</span> <span class="o">+=</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">param_key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param_val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mapviewer_params</span> <span class="o">+=</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="n">param_key</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">param_val</span>

    <span class="k">if</span> <span class="n">is_regular_call</span><span class="p">:</span>
        <span class="c1"># an internal call from our geoportal should lead to the map viewer page without problems</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mapviewer_params&quot;</span><span class="p">:</span> <span class="n">mapviewer_params</span><span class="p">,</span>
            <span class="s2">&quot;mapviewer_src&quot;</span><span class="p">:</span>  <span class="n">LOCAL_MACHINE</span> <span class="o">+</span> <span class="s2">&quot;/mapbender/frames/index.php?lang=&quot;</span> <span class="o">+</span> <span class="n">lang</span> <span class="o">+</span> <span class="s2">&quot;&amp;mb_user_myGui=&quot;</span> <span class="o">+</span> <span class="n">mapviewer_params</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">is_external_search</span><span class="p">:</span>
        <span class="c1"># for an external ajax call we need to deliver a url which can be used to open a new tab which leads to the geoportal</span>
        <span class="k">return</span> <span class="n">GeoportalJsonResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">LOCAL_MACHINE</span> <span class="o">+</span> <span class="s2">&quot;:8000/map-viewer/?&quot;</span> <span class="o">+</span> <span class="n">request_get_params_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;searchResultParam&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get_response</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># for an internal search result selection, where the dynamic map viewer overlay shall be used</span>
        <span class="k">return</span> <span class="n">GeoportalJsonResponse</span><span class="p">(</span><span class="n">mapviewer_params</span><span class="o">=</span><span class="n">mapviewer_params</span><span class="p">)</span><span class="o">.</span><span class="n">get_response</span><span class="p">()</span></div>


<div class="viewcode-block" id="activation_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.activation_view">[docs]</a><span class="k">def</span> <span class="nf">activation_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">activation_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View for activating user account after creation or deletion</span>

<span class="sd">    After creating an account, a user has to verify his email by clicking a link that was send to him.</span>
<span class="sd">    After deleting an account, a user can reactivate his account by clicking a link in the email.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: HTTPRequest</span>
<span class="sd">        activation_key (slug): Key to activate the user, stored in database</span>
<span class="sd">    Returns:</span>
<span class="sd">        Template:</span>
<span class="sd">         (activation.html) in case activation was successful</span>
<span class="sd">         (404.html) in case activation failed for some reason</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">activation_key</span><span class="o">=</span><span class="n">activation_key</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Account already active&quot;</span><span class="p">))</span>
        <span class="n">activated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;404.html&#39;</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">activation_key</span><span class="o">=</span><span class="n">activation_key</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid data&quot;</span><span class="p">))</span>
        <span class="n">activated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;404.html&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">MbUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">activation_key</span><span class="o">=</span><span class="n">activation_key</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">activated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;activation.html&#39;</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;headline&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Account activation&#39;</span><span class="p">),</span>
        <span class="s2">&quot;activated&quot;</span><span class="p">:</span> <span class="n">activated</span><span class="p">,</span>
        <span class="s2">&quot;navigation&quot;</span><span class="p">:</span> <span class="n">helper</span><span class="o">.</span><span class="n">get_navigation_items</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1">#geoportal_context = GeoportalContext(request=request)</span>
    <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

    <span class="n">pprint</span><span class="p">(</span><span class="n">geoportal_context</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">())</span></div>


<div class="viewcode-block" id="feedback_view"><a class="viewcode-back" href="../../modules/views.html#useroperations.views.feedback_view">[docs]</a><span class="k">def</span> <span class="nf">feedback_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Renders a feedback form for the user</span>

<span class="sd">    Args:</span>
<span class="sd">        request:</span>
<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># form is returning</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">FeedbackForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Feedback sent. Thank you!&quot;</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;sender&quot;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;first_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;family_name&quot;</span><span class="p">],</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">send_mail</span><span class="p">(</span>
                    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;[Geoportal] Feedback&quot;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span>
                    <span class="n">from_email</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">],</span>
                    <span class="n">recipient_list</span><span class="o">=</span><span class="p">[</span><span class="n">ROOT_EMAIL_ADDRESS</span><span class="p">],</span>
                    <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPException</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not send feedback mail!&quot;</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;An error occured during sending. Please inform an administrator.&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;An error occured during sending. Please inform an administrator.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">index_view</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># create the form</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;feedback_form.html&quot;</span>
        <span class="n">feedback_form</span> <span class="o">=</span> <span class="n">FeedbackForm</span><span class="p">()</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">feedback_form</span><span class="p">,</span>
            <span class="s2">&quot;btn_send&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Send&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">geoportal_context</span> <span class="o">=</span> <span class="n">GeoportalContext</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="n">geoportal_context</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">geoportal_context</span><span class="o">.</span><span class="n">get_context</span><span class="p">(),</span> <span class="n">template_name</span><span class="o">=</span><span class="n">template</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Geoportal</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/views.html">Views</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, André Holl, Michel Peltriaux, Armin Retterath.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>