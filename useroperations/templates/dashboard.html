{% extends 'base.html' %}
{% load static %}
{% block body %}

<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<!-- <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="{% static 'js/update_graph.js' %}"></script><body> 
    

    <!-- Modal -->
       <div class="modal fade" id="graphModal" tabindex="-1" role="dialog" aria-labelledby="graphModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document"> <!-- Added modal-dialog-centered class -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="graphModalLabel">Graph</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="dynamicContent">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                    <iframe id="modalGraphContent" width="100%" height="400px" frameborder="0"></iframe>
                </div>
               
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="landing-page-box1"><!--landing-page-box-Begin -->
        <div class="landing-page-headline">
            <h2>Statistik</h2>
        </div>
        <div class="quickstart-container">
            <a class="quickstart search" href="#" title="Suche nach allen Karten starten" data-resource="wmc">
                <div class="quickstart-header">
                    <i class="fas fa-map" title="Web Map Context" aria-hidden="true"></i>
                    <span>Number of Registered Users:</span>
                </div>
                <span class="quickstart-body">{{user_count}}</span>
            </a>
            <a class="quickstart search" href="#" title="Suche nach allen Kartenebenen">
                <div class="quickstart-header">
                    <i class="fas fa-layer-group" title="Kartenebenen" aria-hidden="true"></i>
                    <span>Number of WMS:</span>
                </div>
                <span class="quickstart-body">{{ wms_count|safe }}</span>
            </a>
            <a class="quickstart search" href="#" title="Suche nach allen Datensätzen">
                <div class="quickstart-header">
                    <i class="fas fa-globe" title="Datensätze" aria-hidden="true"></i>
                    <span>Number of WFS:</span>
                </div>
              
                <span class="quickstart-body"> {{ wfs_count|safe }}</span>
            </a>
        </div>
    </div>
    <div class="container mt-4">
        <div class="row">
                       <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="iframe-container">
                        <iframe id="graph1" src="{{ image_path }}" width="600px" height="400px" alt="Plotly Image"></iframe>
                        <div class="overlay" onclick="showGraphInModal('fig_html')"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="iframe-container">
                        <iframe id="graph2" src="{{ image_path_wms }}" width="600px" height="400px" alt="Plotly Image"></iframe>
                        <div class="overlay" onclick="showGraphInModal('fig_wms')"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="iframe-container">
                        <iframe id="graph3" src="{{ image_path_session }}" width="600px" height="400px" alt="Plotly Image"></iframe>
                        <div class="overlay" onclick="showGraphInModal('session_data')"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="iframe-container">
                        <iframe id="graph4" src="{{ image_path_report }}" width="600px" height="400px" alt="Plotly Image"></iframe>
                        <div class="overlay" onclick="showGraphInModal('fig_html_report')"></div>
                    </div>
                </div>
            </div>
            </div>
    </div>
    <script>
       function showGraphInModal(contentType) {
        const filterUrl = `http://127.0.0.1:8000/filter/`;
    
        $.get(filterUrl, function(data) {
            let htmlContent = '';
    
            if (contentType === 'fig_html_report') {
                htmlContent = `
                    <h1>Generate Reporting Date</h1>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <button id="reportForm" type="submit" data-url="{% url 'dashboard:filter' %}">Upload</button>
                    </form>
                `;
            } else {
                htmlContent = `
                    <label for="start_date">Start Date:</label>
                    <input type="date" id="start_date" name="start_date" value="{{start_date}}">
                    <label for="end_date">End Date:</label>
                    <input type="date" id="end_date" name="end_date" value="{{end_date}}">
                    <button id="update_graph_btn" data-url="{% url 'dashboard:filter' %}">Filter</button>
                `;
            }
    
            $('#dynamicContent').html(htmlContent);
            $('#modalGraphContent').attr('srcdoc', data[contentType]);
    
            $('#graphModal').modal({
                backdrop: false
            });
    
            if (contentType !== 'fig_html_report') {
                document.getElementById('update_graph_btn').addEventListener('click', function() {
                    const startDate = document.getElementById('start_date').value;
                    const endDate = document.getElementById('end_date').value;
                    const url = this.getAttribute('data-url');
    
                    $.ajax({
                        url: url,
                        type: 'GET',
                        data: {
                            start_date: startDate,
                            end_date: endDate
                        },
                        success: function(data) {
                            $('#modalGraphContent').attr('srcdoc', data[contentType]);
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to fetch the content from ' + url);
                        }
                    });
                });
            }
        }).fail(function() {
            console.error('Failed to fetch the content from ' + filterUrl);
        });
    }
</script>
<script>
    $(document).ready(function() {
        $('#uploadBtn').on('click', function(event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData($('#uploadForm')[0]);
            //const url = $(this).data('url'); // Get the form action URL
            const url = this.getAttribute('data-url');
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    // Display filtered data in modal
                    let filteredDataHtml = '<table class="table">';
                    response.forEach(row => {
                        filteredDataHtml += '<tr>';
                        row.forEach(cell => {
                            filteredDataHtml += `<td>${cell}</td>`;
                        });
                        filteredDataHtml += '</tr>';
                    });
                    filteredDataHtml += '</table>';

                    $('#modalContent').html(filteredDataHtml);
                    $('#dataModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error('Failed to submit the form: ' + error);
                }
            });
        });
    });
</script>
    <style>
        .iframe-container {
            position: relative;
            width: 590px;
            height: 400px;
        }
        .container{
            max-width: 1100px;
        } 
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        #graph1, #graph2, #graph3, #graph4 {
            border: none;
        }
        .row{
            justify-content: center;
            margin-left: -90px;
        } 
        .cookie-container{
            display: none;
        } 
        .modal-backdrop {
            background-color: transparent !important;
            opacity: 0.5 !important;
        }
        .modal {
            pointer-events: auto !important;
        }
                
        .modal-dialog {
            max-width: 90%; 
        }
        
        .modal-body {
            max-height: 70vh; /* Set a maximum height for the modal body */
            overflow-y: auto; /* Enable vertical scrolling */
        }
    </style>
</body>
{% endblock %}