{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% load static %}
{% block body %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="{% static 'js/jquery-ui.min.js' %}"></script>
<script src="{% static 'js/update_graph.js' %}"></script>

      <!-- Modal -->
    <div class="modal fade" id="graphModal" tabindex="-1" role="dialog" aria-labelledby="graphModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="graphModalLabel">Graph</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    
                    <div id="dynamicContent">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                    <div id="reportContainer">
                        <!-- Report content will be injected here by the generate_report function -->
                    </div>
                        <div id="spinnerContainer" style="display: none;">
                        <div id="spinner" class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <iframe id="modalGraphContent" width="100%" height="470px" frameborder="0"></iframe>
                </div>
                <div class="modal-footer">
                        <a id="downloadWmsCsvLink" href="#" class="btn btn-primary">Download CSV</a>
                    <button type="button" class="btn btn-info" id="userCreationReportButton">User Defined Report</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    

    <div class="landing-page-bo"><!--landing-page-box-Begin -->
        <div class="landing-page-headline">
            <h2>Statistik</h2>
        </div>
        <div class="quickstart-container">
            <a class="quickstart searc" href="#" title="Suche nach allen Karten starten">
                <div class="quickstart-header">
                    <i class="fas fa-map" title="Web Map Context" aria-hidden="true"></i>
                    <span>Number of Registered Users:</span>
                </div>
                <span class="quickstart-body">{{user_count}}</span>
            </a>
            <a class="quickstart searc" href="#" title="Suche nach allen Kartenebenen">
                <div class="quickstart-header">
                    <i class="fas fa-layer-group" title="Kartenebenen" aria-hidden="true"></i>
                    <span>Number of WMS:</span>
                </div>
                <span class="quickstart-body">{{ wms_count|safe }}</span>
            </a>
            <a class="quickstart searc" href="#" title="Suche nach allen Datensätzen">
                <div class="quickstart-header">
                    <i class="fas fa-globe" title="Datensätze" aria-hidden="true"></i>
                    <span>Number of WFS:</span>
                </div>
              
                <span class="quickstart-body"> {{ wfs_count|safe }}</span>
            </a>
            <a class="quickstart searc" href="#" title="Suche nach allen Datensätzen">
                <div class="quickstart-header">
                    <i class="fas fa-globe" title="Datensätze" aria-hidden="true"></i>
                    <span>Number of WMC:</span>
                </div>
              
                <span class="quickstart-body"> {{ wmc_count|safe }}</span>
            </a>
        </div>
    </div>
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-6 col-sm-12 mb-4">
                    <div class="card" data-content-type="fig_html">
                        <div class="iframe-container">
                            <iframe id="graph1" src="data:image/png;base64,{{ image_base64}}" width="100%" height="400px" alt="Plotly Image"></iframe>
                            <div class="overlay" onclick="showGraphInModal('fig_html')"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-sm-12 mb-4">
                    <div class="card" data-content-type="fig_wms">
                        <div class="iframe-container">
                            <!-- Replace the iframe with an img tag and use the base64 encoded image -->
                            <iframe id="graph2" src="data:image/png;base64,{{ image_base64_wms}}" width="100%" height="400px" alt="Plotly Image"></iframe>
                            <div class="overlay" onclick="showGraphInModal('fig_wms')"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-sm-12 mb-4">
                    <div class="card" data-content-type="session_data">
                        <div class="iframe-container">
                            <iframe id="graph3" src="data:image/png;base64,{{ image_base64_session}}" width="100%" height="400px" alt="Plotly Image"></iframe>
                            <div class="overlay" onclick="showGraphInModal('session_data')"></div>
                        </div>
                    </div>
                </div>
                <!-- <div class="col-md-6 col-sm-12 mb-4">
                    <div class="card">
                        <div class="iframe-container">
                            <iframe id="graph4" src="{{ image_path_report }}" width="100%" height="400px" alt="Plotly Image"></iframe>
                            <div class="overlay" onclick="showGraphInModal('fig_html_report')"></div>
                        </div>
                    </div>
                </div> -->
                <div class="col-md-6 col-sm-12 mb-4">
                    <div class="card" data-content-type="fig_wfs">
                        <div class="iframe-container">
                            <iframe id="graph4" src="data:image/png;base64,{{ image_base64_wfs}}" width="100%" height="400px" alt="Plotly Image"></iframe>
                            <div class="overlay" onclick="showGraphInModal('fig_wfs')"></div>
                            
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-sm-12 mb-4">
                    <div class="card" data-content-type="fig_wmc">
                        <div class="iframe-container">
                            <iframe id="graph5" src="data:image/png;base64,{{ image_base64_wmc}}" width="100%" height="400px" alt="Plotly Image"></iframe>
                            <div class="overlay" onclick="showGraphInModal('fig_wmc')"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-sm-12 mb-4">
                    <div class="card" data-content-type="echarts_wms">
                        <div class="iframe-container">
                            <!-- Include ECharts library -->
                            <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
                            <!-- ECharts container -->
                            <div id="chart1" style="width: 100%; height: 400px;"></div>
                            <div class="overlay" onclick="showGraphInModal('echarts_wms')"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <div class="col-md-12 col-sm-12 mb-4">
            <a href="{% url 'dashboard:check_abstracts' %}" class="btn btn-primary" role="button">Service Health Monitoring</a>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
 <!-- <div id="chart1" style="width: 100%; height: 400px;"></div>
       -->

<!-- Existing content -->


<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<div class="container">
    <div class="row">
        <!-- Left Column: Gauge Chart and Donut Charts -->
        <div class="col-md-6">
            <div id="gaugeChart" style="width: 100%; height: 330px;">
                {{ gauge_graph|safe }}
            </div>
            <div id="highestLoad" style="width: 100%; height: 330px;">
               {{ highest_loads|safe }} 
            </div>
            <div id="donutChart3" style="width: 100%; height: 200px;"></div>
        </div>
        <!-- Right Column: Graph Charts -->
        <div class="col-md-6">
            <div id="graphChart1" class="graph-chart" style="width: 100%; height: 200px;" data-url ="${filterUrl}">
                {{ loadcount_chart|safe }}
            </div>
            <div id="graphChart2" class="graph-chart" style="width: 100%; height: 200px;"></div>
            <div id="graphChart3" class="graph-chart" style="width: 100%; height: 200px;"></div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="graphModalWMC" tabindex="-1" role="dialog" aria-labelledby="graphModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="graphModalLabel">Graph</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
                       <div class="modal-body">
                <form id="dateForm">
                    <div class="row">
                        <div class="col-12 d-flex flex-wrap flex-md-nowrap py-1">
                            <div class="col-sm-12 col-md-4 py-1">
                                <small class="text-black">Select WMC</small>
                                <div class="card shadow-sm">
                                    <div class="input-group">
                                        <span class="input-group-text" style="height: 30px;" id="addon-wrapping_wmc">
                                            <i class="fa fa-list"></i>
                                        </span>
                                        <select class="form-control" id="wmc_id" name="wmc_id" style="height: 30px; font-size: small; color: rgb(87, 115, 158);" aria-label="Select WMC" aria-describedby="addon-wrapping_wmc">
                                            {% for wmc in top_ten_wmc %}
                                                <option value="{{ wmc.wmc_id }}">{{ wmc.wmc_title }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-4 py-1">
                                <small class="text-black">Start Date</small>
                                <div class="card shadow-sm">
                                    <div class="input-group">
                                        <span class="input-group-text" style="height: 30px;" id="addon-wrapping_start">
                                            <i class="fa fa-calendar-day"></i>
                                        </span>
                                        <input type="date" id="startDateWMC" name="start" value="{{ start_date }}" class="form-control" style="height: 30px; font-size: small; color: rgb(87, 115, 158);" placeholder="Start Date" aria-label="Start Date" aria-describedby="addon-wrapping_start">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-4 py-1">
                                <small class="text-black">End Date</small>
                                <div class="card shadow-sm">
                                    <div class="input-group">
                                        <span class="input-group-text" style="height: 30px;" id="addon-wrapping_end">
                                            <i class="fa fa-calendar-day"></i>
                                        </span>
                                        <input type="date" id="endDateWMC" value="{{ end_date }} " name="end" class="form-control" style="height: 30px; font-size: small; color: rgb(87, 115, 158);" placeholder="End Date" aria-label="End Date" aria-describedby="addon-wrapping_end">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 d-flex justify-content-end py-1">
                            <button type="submit" class="btn btn-primary" style="height: 38px; padding: 0.375rem 0.75rem;">Submit</button>
                        </div>
                    </div>
                </form>
                <div id="spinnerContainerWMC" style="display: none;">
                    <div id="spinner" class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                <div id="dynamicContentWMC">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
<div id="weather-container">
    <button id="playPause" class="play-pause-button">&#10074;&#10074;</button>
{% for city_data in weather_data %}
<div class="weather-data">
    <h2 id="cityName" class="city-name">{{ city_data.city }}</h2>
    <div class="weather-info">
        <img src="{{ city_data.precipitation_image_url }}" alt="Weather icon">
        <p><strong>{{ city_data.temperature }} °C</strong></p>
    </div>
</div>
{% endfor %}
</div>
<script>
	function fetchWeatherData() {
	 fetch('localhost:8000/weather/')
		 .then(response => response.json())
		 .then(data => {
			 const weatherContainer = document.getElementById('weather-container');
 
			 // Loop over each city's data and add it to the weather container
			 for (const city in data) {
				 const cityData = data[city];
				 const cityDiv = document.createElement('div');
				 cityDiv.className = 'weather-data';
 
				 const cityTitle = document.createElement('h2');
				 cityTitle.textContent = city;
				 cityDiv.appendChild(cityTitle);
 
				 const weatherInfo = document.createElement('div');
				 weatherInfo.className = 'weather-info';
 
				 const weatherImage = document.createElement('img');
				 weatherImage.src = cityData.precipitation_image_url;
				 weatherImage.alt = 'Weather icon';
				 weatherInfo.appendChild(weatherImage);
 
				 const temperature = document.createElement('p');
				 temperature.innerHTML = `<strong>${cityData.temperature} °C</strong>`;
				 weatherInfo.appendChild(temperature);
 
				 cityDiv.appendChild(weatherInfo);
				 weatherContainer.appendChild(cityDiv);
			 }
		 });
 }

 // Fetch new weather data every minute
 setInterval(fetchWeatherData, 120000);

 </script>
<script>
        
	var isPaused = false;
	
	document.getElementById('playPause').addEventListener('click', function() {
		isPaused = !isPaused;
		updateButtonState();
	});
	
	
	window.onload = function(){ 
	var weatherDataElements = document.getElementsByClassName('weather-data');
	var currentWeatherDataIndex = 0;
	
	function showNextWeatherData() {
		setTimeout(showNextWeatherData, 5000);
		if (isPaused){
			return;
		} 
		// Hide all weather data
		for (var i = 0; i < weatherDataElements.length; i++) {
			weatherDataElements[i].classList.remove('visible'); 
		}

	
		// Show the current weather data
		weatherDataElements[currentWeatherDataIndex].classList.add('visible');
		
		// Move to the next weather data
		currentWeatherDataIndex++;
		if (currentWeatherDataIndex >= weatherDataElements.length) {
			currentWeatherDataIndex = 0;
		}
	}
	
	// Start the cycle
	showNextWeatherData();
	}

	function updateButtonState() {
var playPauseButton = document.getElementById('playPause');

if (isPaused) {
	playPauseButton.innerHTML = '&#9654;'; // Play symbol
} else {
	playPauseButton.innerHTML = '&#10074;&#10074;'; // Pause symbol
	showNextWeatherData();
}
}
	</script>
<script>
      

       
        // Initialize the donut charts
        //const donutChart1 = echarts.init(document.getElementById('donutChart1'));
        //const donutChart2 = echarts.init(document.getElementById('donutChart2'));
        // const donutChart3 = echarts.init(document.getElementById('donutChart3'));

        //donutChart1.setOption(donutOptions);
        //donutChart2.setOption(donutOptions);
        //donutChart3.setOption(donutOptions);

        // Initialize the graph charts
        //const graphChart1 = echarts.init(document.getElementById('graphChart1'));
        //const graphChart2 = echarts.init(document.getElementById('graphChart2'));
        // const graphChart3 = echarts.init(document.getElementById('graphChart3'));

        //graphChart1.setOption(graphOptions);
        //graphChart2.setOption(graphOptions);
        // graphChart3.setOption(graphOptions);

        document.querySelectorAll('.graph-chart').forEach(chart => {
        chart.addEventListener('click', () => {
            $('#spinnerContainerWMC').show(); // Show spinner
            $.ajax({
                url: filterUrl,
                method: 'GET',
                success: function(data) {
                    $('#dynamicContentWMC').html(data.loadcount_chart);
                    $('#startDateWMC').val(data.start);
                    $('#endDateWMC').val(data.end);
                    $('#wmc_id').val(data.wmc_id);
                    $('#graphModalWMC').modal('show');
                    $('#spinnerContainerWMC').hide(); // Hide spinner
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                    $('#spinnerContainerWMC').hide(); // Hide spinner
                }
            });
        });
    });

    // Handle form submission
    $('#dateForm').on('submit', function(event) {
        event.preventDefault();
        const startDateWMC_get = $('#startDateWMC').val();
        const endDateWMC_get = $('#endDateWMC').val();
        const wmcId = $('#wmc_id').val();
        $('#spinnerContainerWMC').show(); // Show spinner
        $.ajax({
            url: filterUrl,
            method: 'GET',
            data: {
                start: startDateWMC_get,
                end: endDateWMC_get,
                wmc_id: wmcId
            },
            success: function(data) {
                $('#dynamicContentWMC').html(data.loadcount_chart);
                $('#spinnerContainerWMC').hide(); // Hide spinner
            },
            error: function(xhr, status, error) {
                console.error('Error fetching data:', error);
                $('#spinnerContainerWMC').hide(); // Hide spinner
            }
        });
    });
     // Prevent form submission on input field focus
     $('#startDateWMC, #endDateWMC').off('focus').on('focus', function(event) {
            event.stopPropagation();
        });
</script>




  
    
        <script>
            const filterUrl = "{% url 'dashboard:filter' %}";
            const downloadCsvUrl = "{% url 'dashboard:download_csv' %}";
            const startDate = "{{ start_date }}";
            const endDate = "{{ end_date }}";
            const csrfToken = "{{ csrf_token }}";
            const formHtml = `{{ form.as_p|safe }}`;
        </script>
          
 <style>
    .play-pause-button {
    border: none;
    color: white;
    background-color: #000000;
    border-radius: 50%;
    width: 35px; /* Fixed width */
    height: 35px; /* Fixed height */
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.weather-data {
    position: absolute;
    margin-left: 115px;
    top: 0;
    left: 0;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-100%);
    transition: opacity 1s ease-in-out, visibility 0.2s ease-in-out, transform 0.2s ease-in-out;
}

.weather-data.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
#weather-container {
    position: absolute;
    top: 10px;
    right: 0;
    width: 300px;  /* Adjust as needed */
    height: 200px; /* Adjust as needed */
    overflow: hidden; /* Hide any content that goes outside the container */
}

    /* #weather-data:hover {
        transform: scale(1.1); 
    } */

    .weather-info {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .weather-info img {
        width: 30px;
        height: 30px;
    }

    .weather-info h2, .weather-info p {
        margin: 0;
    }
 </style>
</body>
{% endblock %}